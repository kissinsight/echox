"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2375],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),l=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return r.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),p=l(n),m=o,h=p["".concat(s,".").concat(m)]||p[m]||d[m]||a;return n?r.createElement(h,i(i({ref:t},u),{},{components:n})):r.createElement(h,i({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=m;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c[p]="string"==typeof e?e:o,i[1]=c;for(var l=2;l<a;l++)i[l]=n[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6507:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>c,toc:()=>l});var r=n(7462),o=(n(7294),n(3905));const a={description:"Context in Echo",slug:"/context",sidebar_position:4},i="Context",c={unversionedId:"guide/context",id:"guide/context",title:"Context",description:"Context in Echo",source:"@site/docs/guide/context.md",sourceDirName:"guide",slug:"/context",permalink:"/docs/context",draft:!1,editUrl:"https://github.com/labstack/echox/blob/master/website/docs/guide/context.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{description:"Context in Echo",slug:"/context",sidebar_position:4},sidebar:"docsSidebar",previous:{title:"Binding",permalink:"/docs/binding"},next:{title:"Cookies",permalink:"/docs/cookies"}},s={},l=[{value:"Extending",id:"extending",level:2},{value:"Concurrency",id:"concurrency",level:2},{value:"Solution",id:"solution",level:3}],u={toc:l},p="wrapper";function d(e){let{components:t,...n}=e;return(0,o.kt)(p,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"context"},"Context"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"echo.Context")," represents the context of the current HTTP request. It holds request and\nresponse reference, path, path parameters, data, registered handler and APIs to read\nrequest and write response. As Context is an interface, it is easy to extend it with\ncustom APIs."),(0,o.kt)("h2",{id:"extending"},"Extending"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Define a custom context")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'type CustomContext struct {\n    echo.Context\n}\n\nfunc (c *CustomContext) Foo() {\n    println("foo")\n}\n\nfunc (c *CustomContext) Bar() {\n    println("bar")\n}\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Create a middleware to extend default context")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"e.Use(func(next echo.HandlerFunc) echo.HandlerFunc {\n    return func(c echo.Context) error {\n        cc := &CustomContext{c}\n        return next(cc)\n    }\n})\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"This middleware should be registered before any other middleware.")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Custom context cannot be defined in a middleware before the router ran (Pre)")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Use in handler")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'e.GET("/", func(c echo.Context) error {\n    cc := c.(*CustomContext)\n    cc.Foo()\n    cc.Bar()\n    return cc.String(200, "OK")\n})\n')),(0,o.kt)("h2",{id:"concurrency"},"Concurrency"),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"Context")," must not be accessed out of the goroutine handling the request. There are two reasons:"),(0,o.kt)("ol",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"Context")," has functions that are dangerous to execute from multiple goroutines. Therefore, only one goroutine should access it."),(0,o.kt)("li",{parentName:"ol"},"Echo uses a pool to create ",(0,o.kt)("inlineCode",{parentName:"li"},"Context"),"'s. When the request handling finishes, Echo returns the ",(0,o.kt)("inlineCode",{parentName:"li"},"Context")," to the pool.")),(0,o.kt)("p",{parentName:"admonition"},"See issue ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/labstack/echo/issues/1908"},"1908"),' for a "cautionary tale" caused by this reason. Concurrency is complicated. Beware of this pitfall when working with goroutines.')),(0,o.kt)("h3",{id:"solution"},"Solution"),(0,o.kt)("p",null,"Use a channel"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'func(c echo.Context) error {\n    ca := make(chan string, 1) // To prevent this channel from blocking, size is set to 1.\n    r := c.Request()\n    method := r.Method\n\n    go func() {\n        // This function must not touch the Context.\n\n        fmt.Printf("Method: %s\\n", method)\n\n        // Do some long running operations...\n\n        ca <- "Hey!"\n    }()\n\n    select {\n    case result := <-ca:\n        return c.String(http.StatusOK, "Result: "+result)\n    case <-c.Request().Context().Done(): // Check context.\n        // If it reaches here, this means that context was canceled (a timeout was reached, etc.).\n        return nil\n    }\n}\n')))}d.isMDXComponent=!0}}]);